{% extends "base.html" %}
{% block title %}{{ manga_name }} - {{ chapter_name }}{% endblock %}

{% block content %}
<form class="chapter-navigation-form">
    <label for="chapter-select">Autres chapitres :</label>
    <select id="chapter-select" class="chapter-select-dropdown" onchange="if(this.value) window.location.href='{{ url_for('reader', manga_name=manga_name, chapter_name='CHAP_PLACEHOLDER') }}'.replace('CHAP_PLACEHOLDER', this.value);">
        {% for chap in all_chapters %}
        <option value="{{ chap }}" {% if chap == chapter_name %}selected{% endif %} style="padding: 5px; border-radius: 10px; background: #f0f0f0;">{{ chap }}</option>
        {% endfor %}
    </select>
</form>
<div class="chapter-navigations">
    {% if prev_chapter %}
        <a href="{{ prev_chapter }}" class="chapter-nave-link">
            <i class="fas fa-arrow-left" style="margin-left: 4px;"></i>Chapitre précédent
        </a>
    {% endif %}
    {% if next_chapter %}
        <a href="{{ next_chapter }}" class="chapter-nav-link">
            Chapitre suivant<i class="fas fa-arrow-right" style="margin-right: 5px;"></i>
        </a>
    {% endif %}
</div>
<div class="reader-container">
    <h1 class="reader-title">{{ manga_name }} - {{ chapter_name }}</h1>
    <div class="reader-controls">
        <button id="btnScrollMode">Mode scroll<i class="fa fa-arrows-v" style="gap: 3px;"></i></button>
        <button id="btnPageMode">Mode page <i class="fa fa-arrows-h" style="gap: 3px;"></i></button>
        <button id="dark-mode-toggle" class="dark-mode-btn" title="Mode sombre"><i class="fas fa-moon"></i> Mode Sombre</button>
        <button id="light-mode-toggle" class="dark-mode-btn" title="Mode clair"><i class="fas fa-sun"></i> Mode Clair</button>
    </div>
    <div id="scroll-mode" style="display: flex;">
        <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
            {% for image in images %}
                <img class="reader-img zoomable" src="{{ url_for('manga_image', manga_name=manga_name, chapter_name=chapter_name, filename=image) }}" alt="Page {{ loop.index }}" style="max-width:100vw;width:100%;height:auto;">
            {% endfor %}
        </div>
    </div>
    <div id="page-mode" style="display: none;">
        <div style="display:flex;flex-direction:column;align-items:center;width:100%;">
            <!-- src initial vide: on remplira depuis JS pour éviter les problèmes d'encodage des URLs -->
            <img id="page-img" class="reader-img zoomable" src="" alt="Page 1" style="max-width:100vw;width:100%;height:auto;">
            <div class="page-navigation">
                <button type="button" onclick="prevPage()">Précédent</button>
                <span id="page-number" class="page-number-display">1 / {{ images|length }}</span>
                <button type="button" onclick="nextPage()">Suivant</button>
            </div>
        </div>
    </div>
<div class="reader-actions">
    <a href="{{ url_for('manga', manga_name=manga_name) }}" class="nav-links">Retour au manga</a>
    <a href="{{ url_for('download_chapter', manga_name=manga_name, chapter_name=chapter_name) }}" class="nav-links" download>
        <i class="fas fa-download" style="margin-right: 5px; gap: 2px;"></i>Télécharger ce chapitre
    </a>
</div>
    </div>
<style>
.reader-img.zoomable {
    transition: transform 0.2s;
    cursor: zoom-in;
    z-index: 1;
}
.reader-img.zoomable.zoomed {
    transform: scale(1.8);
    cursor: zoom-out;
    z-index: 10;
}
/* Uniformité et collage en mode scroll */
/* Uniformité stricte en mode scroll */
#scroll-mode .reader-img.zoomable {
    display: block;
    width: 100vw !important;
    max-width: 100vw !important;
    min-width: 100vw !important;
    height: auto !important;
    margin: 0 !important;
    padding-left: 20px !important;
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    object-fit: cover !important;
    background: #181818;
    margin-right: 0px !important;
}
#scroll-mode .reader-img.zoomable.zoomed {
    padding-left: 120px !important;
    transition: padding-left 0.2s;
    margin-right: 90px !important;
}
#scroll-mode > div {
    gap: 0 !important;
}

/* Réduction de la taille des images sur PC (écrans larges) */
@media (min-width: 900px) {
    #scroll-mode .reader-img.zoomable,
    #page-mode .reader-img.zoomable,
    #page-mode #page-img {
        width: 60vw !important;
        max-width: 60vw !important;
        min-width: 60vw !important;
        margin: 0 auto !important;
        padding-left: 0 !important;
    }
}

/* Désactivation du zoom sur PC */
@media (pointer: fine) {
    .reader-img.zoomable,
    #page-img.zoomable {
        cursor: default !important;
        pointer-events: none !important;
        transition: none !important;
    }
}
</style>
<script>
    // Sérialisation sécurisée des URLs d'images côté serveur -> JSON côté client
    let images = [{% for f in images %}{{ url_for('manga_image', manga_name=manga_name, chapter_name=chapter_name, filename=f) | tojson }}{% if not loop.last %}, {% endif %}{% endfor %}];
    let currentPage = 0;
 
     function setMode(mode) {
         document.getElementById('scroll-mode').style.display = (mode === 'scroll') ? 'block' : 'none';
         document.getElementById('page-mode').style.display = (mode === 'page') ? 'block' : 'none';
     }
 
     function showPage(idx) { 
         if (idx < 0 || idx >= images.length) return;
         currentPage = idx;
         document.getElementById('page-img').src = images[currentPage];
         document.getElementById('page-number').innerText = (currentPage+1) + " / " + images.length;
     }
 
     function prevPage() { showPage(currentPage-1); }
     function nextPage() { showPage(currentPage+1); }
 
     function updateThemeButtons() {
         const isDark = document.body.classList.contains('dark-mode');
         document.getElementById('dark-mode-toggle').style.display = isDark ? 'none' : 'inline-block';
         document.getElementById('light-mode-toggle').style.display = isDark ? 'inline-block' : 'none';
     }

    function setTheme(dark) {
        if (dark) {
            document.body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark');
        } else {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('theme', 'light');
        }
        updateThemeButtons();
    }

    document.addEventListener("DOMContentLoaded", function() {
        // Zoom uniquement sur double-tap/double-clic, mais PAS sur PC
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        document.querySelectorAll('.reader-img.zoomable').forEach(function(img) {
            if (isTouchDevice) {
                let lastTap = 0;
                img.addEventListener('dblclick', function(e) {
                    img.classList.toggle('zoomed');
                });
                img.addEventListener('touchend', function(e) {
                    let now = new Date().getTime();
                    if (now - lastTap < 350) {
                        img.classList.toggle('zoomed');
                        e.preventDefault();
                    }
                    lastTap = now;
                });
            }
        });
        showPage(0);

        // Appliquer le thème sauvegardé
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
        updateThemeButtons();

        document.getElementById('dark-mode-toggle').onclick = function() { setTheme(true); };
        document.getElementById('light-mode-toggle').onclick = function() { setTheme(false); };

        document.getElementById('page-img').addEventListener('dblclick', function() {
            if (document.fullscreenElement) { document.exitFullscreen(); }
            else { this.requestFullscreen(); }
        });

        // Boutons de mode
        document.getElementById("btnPageMode").onclick = function() {
            setMode("page");
        };
        document.getElementById("btnScrollMode").onclick = function() {
            setMode("scroll");
        };
    });
</script>
{% endblock %}